
from __future__ import annotations
import time
import acconeer.exptool as et
from acconeer.exptool import a121
from acconeer.exptool.a121.algo.distance import Detector, DetectorConfig, ThresholdMethod


SENSOR_ID = 1  # Sensor ID (usually 1 on a single-sensor setup)


def main():
    # --- 1. Setup and connect to radar ---
    args = a121.ExampleArgumentParser().parse_args()
    et.utils.config_logging(args)

    print("Connecting to radar...")
    client = a121.Client.open(**a121.get_client_args(args))

    # --- 2. Configure the detector ---
    detector_config = DetectorConfig(
        start_m=0.1,       # start at 10 cm
        end_m=2.0,         # up to 2 meters
        max_profile=a121.Profile.PROFILE_3,
        max_step_length=12,
        threshold_method=ThresholdMethod.RECORDED,
    )

    detector = Detector(
        client=client,
        sensor_ids=[SENSOR_ID],
        detector_config=detector_config,
    )

    print("Calibrating detector...")
    detector.calibrate_detector()

    print("Starting detector...")
    detector.start()

    interrupt_handler = et.utils.ExampleInterruptHandler()
    print("Radar started. Press Ctrl-C to stop.\n")

    # --- 3. Main measurement loop ---
    while not interrupt_handler.got_signal:
        result = detector.get_next()
        sensor_result = result[SENSOR_ID]

        if len(sensor_result.distances) > 0:
            distance = sensor_result.distances[0]
            print(f"Detected distance: {distance:.3f} m")
        else:
            print("No target detected")

        time.sleep(0.1)  # small delay for readability

    # --- 4. Stop and clean up ---
    print("\nStopping detector...")
    detector.stop()
    print("Disconnecting...")
    client.close()
    print("Done.")


if __name__ == "__main__":
    main()
